<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <link rel="stylesheet" href="styles.css" />
    <script
      type="text/javascript"
      src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=ATfT4hGk5ApycNm-HS7aiRpApd794ezMeWyDMP3m3HBPE4FAZULweJo2dfsOF3Oj3Alr1y9icEyDd9Shcb3anpVpszO2Z89xjrUPQ4KW-wHNfucaZnXdW2khe3OQR7uynG1Fhdraq3efUY7vnAz8UBeTCVyK3384BpRLMReQFaH0BtbC0oubTNASQ752gKih-xtmBkfZGUkiqKwpPuy8qyYRefnLdoZuTM96sFas6RYd55yQB0ucQGOx2rPX3gtvBMtrNmafOyd2BTUAhoRAVuB4-7qW1fyU9dDVYGFqt6BWPsU3bWbl2gm5PicVNGL8epXZFWPTxlxkx2I2D7X06LQbXxEa4yoqgb77SgOK9PkiJq2Ss-Kc_-5qLGtkKRn0NDvsoDzYUgmIeMmd9R-QgJUehrlyyJSgg7BOLo30IGlSBinfk0WgeeZk9cIGqZOBzJQNeE5Ar1dsk5mMl511e3twB5H0Gw1nkR9l-CMdXkw"
      charset="UTF-8"
    ></script>
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comments">
        <!-- в рендере -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name-input"
          onchange="blockButton();"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="comment-area"
          onchange="blockButton();"
        ></textarea>
        <div class="add-form-row">
          <button
            class="add-form-button"
            id="add-form-button"
            disabled="disabled"
          >
            Написать
          </button>
        </div>
      </div>
    </div>

    <!-- добавление нового коммента -->
    <script>
      const butAddComment = document.querySelector(".add-form-button");
      const listOfComments = document.querySelector(".comments");
      const nameInputElement = document.querySelector("#name-input");
      const commentAreaElement = document.querySelector("#comment-area");
      const addForm = document.querySelector(".add-form");

      const allComments = [
        {
          name: "Глеб Фокин",
          date: "12.02.22 12:18",
          textOfComment: "Это будет первый комментарий на этой странице",
          likes: 5,
          liked: false,
        },
        {
          name: "Варвара Н.",
          date: "13.02.22 19:22",
          textOfComment: "Мне нравится как оформлена эта страница! ❤",
          likes: 72,
          liked: true,
        },
      ];

      function blockButton() {
        if (nameInputElement.value === "" || commentAreaElement.value === "") {
          butAddComment.disabled = true;
          // return;
        } else {
          butAddComment.disabled = false;
        }
      }

      const clickLikeButton = () => {
        let likeButton = document.querySelectorAll(".like-button");

        for (let i = 0; i < likeButton.length; i++) {
          likeButton[i].onclick = function (event) {
            event.stopPropagation();
            if (allComments[i].liked === false) {
              allComments[i].liked = true;
              allComments[i].likes += 1;
            } else if (allComments[i].liked === true) {
              allComments[i].liked = false;
              allComments[i].likes -= 1;
            }
            renderComments();
          };
        }
      };

      const initDeleteButtonsListeners = () => {
        const deleteButtonsElements =
          document.querySelectorAll(".delete-button");

        for (const deleteButtonElement of deleteButtonsElements) {
          deleteButtonElement.addEventListener("click", (event) => {
            event.stopPropagation();
            const index = deleteButtonElement.dataset.index;
            console.log(index);
            allComments.splice(index, 1);
            renderComments();
          });
        }
      };

      const renderComments = () => {
        const commentsHtml = allComments
          .map((comment, index) => {
            return `<li data-text='${comment.textOfComment} \n ${
              comment.name
            }' class="comment">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${comment.textOfComment}
            </div>
          </div>
          <div class="comment-footer">
            <div class="but-del">
              <button data-index="${index}" class='delete-button'>Удалить</button>
            </div>
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button class="${
                comment.liked ? "like-button -active-like" : "like-button"
              }"></button>
            </div>
          </div>
        </li>`;
          })
          .join("");

        listOfComments.innerHTML = commentsHtml;
        clickLikeButton();
        initDeleteButtonsListeners();
      };

      renderComments();

      const responseToComment = () => {
        const comments = document.querySelectorAll(".comment");
        const commentArea = document.getElementById("comment-area");
        for (const comment of comments) {
          comment.addEventListener("click", () => {
            const response = comment.dataset.text;
            commentArea.value = response;
          });
        }
      };
      responseToComment();

      const currentDate = new Date();
      let day = currentDate.getDate();
      if (day < 10) {
        day = "0" + day;
      }
      const months = [
        "01",
        "02",
        "03",
        "04",
        "05",
        "06",
        "07",
        "08",
        "09",
        "10",
        "11",
        "12",
      ];
      let month = months[currentDate.getMonth()];
      let year = currentDate.getFullYear() % 100;
      if (year < 10) year = "0" + year;

      let hour = currentDate.getHours();
      if (hour < 10) {
        hour = "0" + hour;
      }
      let minute = currentDate.getMinutes();
      if (minute < 10) {
        minute = "0" + minute;
      }
      const newDate =
        day + "." + month + "." + year + " " + hour + ":" + minute;

      butAddComment.addEventListener("click", () => {
        allComments.push({
          name: nameInputElement.value
            .replaceAll("<", "&lt")
            .replaceAll(">", "&gt"),
          date: newDate,
          textOfComment: commentAreaElement.value
            .replaceAll("<", "&lt")
            .replaceAll(">", "&gt"),
          likes: 0,
          liked: false,
        });

        renderComments();

        // Очищаем поля
        nameInputElement.value = "";
        commentAreaElement.value = "";
        butAddComment.disabled = true;
      });

      addForm.addEventListener("keyup", (action) => {
        if (action.code === "Enter") {
          allComments.push({
            name: nameInputElement.value
              .replaceAll("<", "&lt")
              .replaceAll(">", "&gt"),
            date: newDate,
            textOfComment: commentAreaElement.value
              .replaceAll("<", "&lt")
              .replaceAll(">", "&gt"),
            likes: 0,
            liked: false,
          });

          renderComments();
          responseToComment();

          // Очищаем поля
          nameInputElement.value = "";
          commentAreaElement.value = "";
          butAddComment.disabled = true;
        }
      });
    </script>
  </body>
</html>
