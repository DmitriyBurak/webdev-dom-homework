<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Проект "Комменты"</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comments">
        <!-- в рендере -->
      </ul>
      <div class="add-form" id="isLoading2">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name-input"
          oninput="isValidForm()"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="comment-area"
          oninput="isValidForm()"
        ></textarea>
        <div class="add-form-row">
          <button
            class="add-form-button"
            id="add-form-button"
            disabled="disabled"
          >
            Написать
          </button>
        </div>
      </div>
      <div id="isLoading">
        <div class="add-form">Коментарий добавляется...</div>
        <div
          class="tenor-gif-embed"
          data-postid="25291442"
          data-share-method="host"
          data-aspect-ratio="1"
          data-width="30%"
        >
          <a
            href="https://tenor.com/view/loading-thinking-shiba-inu-gif-25291442"
            >Loading Thinking GIF</a
          >from <a href="https://tenor.com/search/loading-gifs">Loading GIFs</a>
        </div>
        <script
          type="text/javascript"
          async
          src="https://tenor.com/embed.js"
        ></script>
      </div>
    </div>

    <!-- добавление нового коммента -->
    <script>
      const butAddComment = document.querySelector(".add-form-button");
      const listOfComments = document.querySelector(".comments");
      const nameInputElement = document.querySelector("#name-input");
      const commentAreaElement = document.querySelector("#comment-area");
      const addForm = document.querySelector(".add-form");
      document.querySelector("#isLoading").style.display = "none";
      // document.querySelector("#isLoading2").style.display = "none";

      const fetchPromise = fetch(
        "https://webdev-hw-api.vercel.app/api/v1/dima-burak/comments",
        {
          method: "GET",
        }
      );

      // console.log(fetchPromise);

      fetchPromise.then((response) => {
        // console.log(response);
        const jsonPromise = response.json();

        jsonPromise.then((responseData) => {
          console.log(responseData);
          allComments = [...responseData.comments];
          renderComments();
        });
      });

      let allComments = [
        // {
        //   name: "Глеб Фокин",
        //   date: "12.02.22 12:18",
        //   textOfComment: "Это будет первый комментарий на этой странице",
        //   likes: 5,
        //   liked: false,
        // },
        // {
        //   name: "Варвара Н.",
        //   date: "13.02.22 19:22",
        //   textOfComment: "Мне нравится как оформлена эта страница! ❤",
        //   likes: 72,
        //   liked: true,
        // },
      ];

      // function blockButton() {
      //   if (nameInputElement.value === "" || commentAreaElement.value === "") {
      //     butAddComment.disabled = true;
      //     // return;
      //   } else {
      //     butAddComment.disabled = false;
      //   }
      // }

      const isValidForm = () => {
        if (nameInputElement.value === "" || commentAreaElement.value === "") {
          butAddComment.disabled = true;
          return false;
        } else {
          butAddComment.disabled = false;
          return true;
        }
      };

      const clickLikeButton = () => {
        let likeButton = document.querySelectorAll(".like-button");
        for (let i = 0; i < likeButton.length; i++) {
          likeButton[i].onclick = function (event) {
            event.stopPropagation();
            if (allComments[i].liked === false) {
              allComments[i].liked = true;
              allComments[i].likes += 1;
            } else if (allComments[i].liked === true) {
              allComments[i].liked = false;
              allComments[i].likes -= 1;
            }
            renderComments();
            responseToComment();
          };
        }
      };

      const initDeleteButtonsListeners = () => {
        const deleteButtonsElements =
          document.querySelectorAll(".delete-button");

        for (const deleteButtonElement of deleteButtonsElements) {
          deleteButtonElement.addEventListener("click", (event) => {
            event.stopPropagation();
            const index = deleteButtonElement.dataset.index;
            console.log(index);
            allComments.splice(index, 1);
            renderComments();
            responseToComment();
          });
        }
      };

      const renderComments = () => {
        const commentsHtml = allComments
          .map((comment, index) => {
            return `<li data-text='${comment.text} \n ${
              comment.name
            }' class="comment">
          <div class="comment-header">
            <div>${comment.author.name}</div>
            <div>${new Date(comment.date).toLocaleString()}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="but-del">
              <button data-index="${index}" class='delete-button'>Удалить</button>
            </div>
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button class="${
                comment.isLiked ? "like-button -active-like" : "like-button"
              }"></button>
            </div>
          </div>
        </li>`;
          })
          .join("");

        listOfComments.innerHTML = commentsHtml;
        clickLikeButton();
        initDeleteButtonsListeners();
      };

      renderComments();

      const responseToComment = () => {
        const comMents = document.querySelectorAll(".comment");
        const commentArea = document.getElementById("comment-area");
        for (const comment of comMents) {
          comment.addEventListener("click", () => {
            const response = comment.dataset.text;
            commentArea.value = response;
          });
        }
      };
      responseToComment();

      const getCurrentDate = () => {
        const currentDate = new Date();
        let day = currentDate.getDate();
        if (day < 10) {
          day = "0" + day;
        }
        const months = [
          "01",
          "02",
          "03",
          "04",
          "05",
          "06",
          "07",
          "08",
          "09",
          "10",
          "11",
          "12",
        ];
        let month = months[currentDate.getMonth()];
        let year = currentDate.getFullYear() % 100;
        if (year < 10) year = "0" + year;

        let hour = currentDate.getHours();
        if (hour < 10) {
          hour = "0" + hour;
        }
        let minute = currentDate.getMinutes();
        if (minute < 10) {
          minute = "0" + minute;
        }
        const newDate =
          day + "." + month + "." + year + " " + hour + ":" + minute;
        return newDate;
      };

      butAddComment.addEventListener("click", () => {
        // allComments.push({
        //   name: nameInputElement.value
        //     .replaceAll("<", "&lt")
        //     .replaceAll(">", "&gt"),
        //   date: getCurrentDate(),
        //   textOfComment: commentAreaElement.value
        //     .replaceAll("<", "&lt")
        //     .replaceAll(">", "&gt"),
        //   likes: 0,
        //   liked: false,
        // });
        // renderComments();
        // responseToComment();
        document.querySelector("#isLoading").style.display = "block";
        document.querySelector("#isLoading2").style.display = "none";
        fetch("https://webdev-hw-api.vercel.app/api/v1/dima-burak/comments", {
          method: "POST",
          body: JSON.stringify({
            text: commentAreaElement.value
              .replaceAll("<", "&lt")
              .replaceAll(">", "&gt"),
            name: nameInputElement.value
              .replaceAll("<", "&lt")
              .replaceAll(">", "&gt"),
          }),
        }).then((response) => {
          const fetchPromise = fetch(
            "https://webdev-hw-api.vercel.app/api/v1/dima-burak/comments",
            {
              method: "GET",
            }
          );

          fetchPromise.then((response) => {
            const jsonPromise = response.json();
            jsonPromise.then((responseData) => {
              allComments = [...responseData.comments];
              document.querySelector("#isLoading").style.display = "none";
              document.querySelector("#isLoading2").style.display = "flex";
              renderComments();
            });
          });

          // response.json().then((responseData) => {
          //   const appComments = responseData.comments.map((comment) => {
          //     return {
          //       name: comment.author.name,
          //       date: new Date(comment.date),
          //       textOfComment: comment.text,
          //       likes: comment.likes,
          //       liked: false,
          //     };
          //   });
          // });
          // allComments = appComments;
          // renderComments();
        });

        // Очищаем поля
        nameInputElement.value = "";
        commentAreaElement.value = "";
        butAddComment.disabled = true;
      });

      addForm.addEventListener("keyup", (action) => {
        if (action.code === "Enter" && isValidForm()) {
          // allComments.push({
          //   name: nameInputElement.value
          //     .replaceAll("<", "&lt")
          //     .replaceAll(">", "&gt"),
          //   date: getCurrentDate(),
          //   textOfComment: commentAreaElement.value
          //     .replaceAll("<", "&lt")
          //     .replaceAll(">", "&gt"),
          //   likes: 0,
          //   liked: false,
          // });

          // renderComments();
          // responseToComment();

          fetch("https://webdev-hw-api.vercel.app/api/v1/dima-burak/comments", {
            method: "POST",
            body: JSON.stringify({
              text: commentAreaElement.value
                .replaceAll("<", "&lt")
                .replaceAll(">", "&gt"),
              name: nameInputElement.value
                .replaceAll("<", "&lt")
                .replaceAll(">", "&gt"),
            }),
          }).then((response) => {
            const fetchPromise = fetch(
              "https://webdev-hw-api.vercel.app/api/v1/dima-burak/comments",
              {
                method: "GET",
              }
            );

            fetchPromise.then((response) => {
              const jsonPromise = response.json();
              jsonPromise.then((responseData) => {
                allComments = [...responseData.comments];
                renderComments();
              });
            });
          });

          // Очищаем поля
          nameInputElement.value = "";
          commentAreaElement.value = "";
          butAddComment.disabled = true;
        }
      });
    </script>
  </body>
</html>
